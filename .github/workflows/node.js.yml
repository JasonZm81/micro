name: Node.js CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  PROJECT_ID: ${{ secrets.GKE_PROJECT }}

jobs:   
  setup-build-publish-deploy:
    name: Setup, Build, Publish, and Deploy
    runs-on: ubuntu-latest
    environment: production

    strategy:
      matrix:
        node-version: [16.x]
        # See supported Node.js release schedule at https://nodejs.org/en/about/releases/

    steps:
    - uses: actions/checkout@v3
    - name: Use Node.js 
      uses: actions/setup-node@v3
      with:
        node-version: '16.x'
        cache: 'npm'
    - run: npm ci
    - run: pwd

    # Setup gcloud CLI
    - uses: google-github-actions/setup-gcloud@1bee7de035d65ec5da40a31f8589e240eba8fde5
      with:
        service_account_key: ${{ secrets.GKE_SA_KEY }}
        project_id: ${{ secrets.GKE_PROJECT }}
    
    - run: gcloud config get-value project
    - name:  store container in Artifact Registry and deploy it to your cluster from the registry
      run: |- 
        gcloud artifacts repositories create hello-repo \
          --project=logical-flame-386108 \
          --repository-format=docker \
          --location=us-central1 \
          --description="Docker repository"

    - name: Build  container image using Cloud Build  
      run: |- 
        gcloud builds submit \
          --tag us-central1-docker.pkg.dev/logical-flame-386108/hello-repo/helloworld-gke .

    - name: Create the cluster  
      run: |-
        gcloud container clusters create-auto helloworld-gke \
          --region us-central1
    
    - name: Verify that you have access to the cluster  
      run: |-
        kubectl get nodes
    
    - name: Apply the files  
      run: |-
        kubectl apply -f mongo.yaml -f mongo-config.yaml -f mongo-secret.yaml -f webapp.yaml

    - name: get deployments 
      run: |-
        kubectl get deployments

    - name: get pods 
      run: |-
        kubectl get pods

    - name: get services  
      run: |-
        kubectl get services
        

        

    
